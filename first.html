<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Fraud Detection – Index</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body {
  font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
  background: linear-gradient(135deg,#6a11cb,#2575fc);
  min-height: 100vh;
}
.container-box {
  background: #fff;
  border-radius: 12px;
  padding: 30px;
  margin-top: 60px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.25);
}
#slipPreview {
  max-width: 100%;
  max-height: 200px;
  margin-top: 0.5rem;
  display: none;
  border-radius: 0.25rem;
  border: 1px solid #ddd;
}
.result-card {
  border-radius: 8px;
  padding: 15px;
  margin-top: 15px;
  color: #fff;
}
.result-safe { background: #28a745; }
.result-review { background: #ffc107; color: #212529; }
.result-fraud { background: #dc3545; }
</style>
</head>
<body>

<nav class="navbar navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" href="#">Fraud Detector</a>
    <a href="history.html" class="btn btn-outline-light btn-sm">History</a>
  </div>
</nav>

<div class="container container-box">
  <h2 class="mb-4 text-center">Enter Transaction Details</h2>
  <form id="fraudForm">
    <div class="mb-3">
      <label class="form-label">Transaction ID</label>
      <input type="text" id="transactionId" class="form-control" required>
    </div>
    <div class="mb-3">
      <label class="form-label">User ID</label>
      <input type="text" id="userId" class="form-control" required>
    </div>
    <div class="mb-3">
      <label class="form-label">Amount (₹)</label>
      <input type="number" id="amount" class="form-control" required>
    </div>
    <div class="mb-3">
      <label class="form-label">Channel</label>
      <select id="channel" class="form-select">
        <option value="card">Card</option>
        <option value="upi">UPI</option>
        <option value="netbanking">Netbanking</option>
        <option value="wallet">Wallet</option>
      </select>
    </div>
    <div class="mb-3">
      <label class="form-label">Location (city, country)</label>
      <input type="text" id="location" class="form-control" placeholder="Mumbai, India">
    </div>
    <div class="mb-3">
      <label class="form-label">Device ID / IMEI</label>
      <input type="text" id="deviceId" class="form-control" placeholder="device_abc123">
    </div>
    <div class="mb-3">
      <label class="form-label">Upload Payment Slip</label>
      <input type="file" id="paymentSlip" class="form-control" accept="image/*,application/pdf">
      <img id="slipPreview" alt="Slip preview"/>
    </div>
    <button type="submit" class="btn btn-primary w-100" id="detectBtn">Detect Fraud</button>
  </form>
</div>

<script>
// Preview uploaded image
const paymentSlip = document.getElementById('paymentSlip');
const slipPreview = document.getElementById('slipPreview');
paymentSlip.addEventListener('change', () => {
  const file = paymentSlip.files[0];
  if(file && file.type.startsWith('image/')){
    const reader = new FileReader();
    reader.onload = e => { slipPreview.src = e.target.result; slipPreview.style.display = 'block'; };
    reader.readAsDataURL(file);
  } else { slipPreview.style.display = 'none'; }
});

// Load edit record if exists
let editIndex = null;
const editRecord = JSON.parse(localStorage.getItem('editRecord') || 'null');
if(editRecord){
  document.getElementById('transactionId').value = editRecord.transactionId;
  document.getElementById('userId').value = editRecord.userId;
  document.getElementById('amount').value = editRecord.amount;
  document.getElementById('channel').value = editRecord.channel || 'card';
  document.getElementById('location').value = editRecord.location || '';
  document.getElementById('deviceId').value = editRecord.deviceId || '';
  editIndex = editRecord._index;
  localStorage.removeItem('editRecord');
}

// Submit form
document.getElementById('fraudForm').addEventListener('submit', function(e){
  e.preventDefault();

  const transactionId = document.getElementById('transactionId').value.trim();
  const userId = document.getElementById('userId').value.trim();
  const amount = parseFloat(document.getElementById('amount').value);
  const deviceId = document.getElementById('deviceId').value.trim();
  const location = document.getElementById('location').value.trim().toLowerCase();
  const channel = document.getElementById('channel').value;

  // -------- Rule-based fraud detection --------
  let riskScore = 0;

  if(amount > 10000) riskScore += 40;
  if(deviceId.startsWith('device_new')) riskScore += 20;

  const usualLocations = ['mumbai, india', 'delhi, india', 'bangalore, india'];
  if(!usualLocations.includes(location)) riskScore += 20;

  if(channel === 'upi' && amount > 5000) riskScore += 10;

  riskScore += Math.random() * 10;

  let verdict = 'Safe';
  if(riskScore >= 70) verdict = 'Fraudulent';
  else if(riskScore >= 40) verdict = 'Review';
  // --------------------------------------------

  const record = {
    transactionId, userId, amount, channel, location, deviceId, verdict,
    riskScore: riskScore.toFixed(2),
    timestamp: new Date().toLocaleString()
  };

  // Load history
  let history = JSON.parse(localStorage.getItem('fraudHistory') || '[]');
  if(editIndex !== null) history[editIndex] = record;
  else history.unshift(record);
  localStorage.setItem('fraudHistory', JSON.stringify(history.slice(0,100)));

  localStorage.setItem('latestFraudRecord', JSON.stringify(record));
  window.location.href = 'submit.html';
});
</script>

</body>
</html>
